name: Preview Deployment

on:
  push:
    branches:
      - 'preview/issue-*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract issue number
        id: issue
        run: |
          BRANCH=${{ github.ref_name }}
          ISSUE=$(echo $BRANCH | grep -oP 'issue-\K\d+')
          echo "number=$ISSUE" >> $GITHUB_OUTPUT

      - name: Get project from issue labels
        id: project
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the first non-infra project label
          PROJECT=$(gh issue view ${{ steps.issue.outputs.number }} \
            --json labels \
            --jq '[.labels[] | select(.name | startswith("project:")) | .name | sub("project:"; "") | select(. != "infra")] | first')
          echo "name=$PROJECT" >> $GITHUB_OUTPUT

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install Trunk
        run: |
          wget -qO- https://github.com/trunk-rs/trunk/releases/download/v0.21.14/trunk-x86_64-unknown-linux-gnu.tar.gz | tar -xzf-
          sudo mv trunk /usr/local/bin/

      - name: Determine build path
        id: build
        run: |
          PROJECT=${{ steps.project.outputs.name }}
          case $PROJECT in
            helios) echo "dir=SIM/HELIOS" >> $GITHUB_OUTPUT ;;
            welcome) echo "dir=SIM/TOOFOO" >> $GITHUB_OUTPUT ;;
            mcad) echo "dir=MCAD/WEB" >> $GITHUB_OUTPUT ;;
            ecad) echo "dir=ECAD/WEB" >> $GITHUB_OUTPUT ;;
            chladni) echo "dir=SW/CHLADNI" >> $GITHUB_OUTPUT ;;
            autocrate) echo "dir=MCAD/AUTOCRATE" >> $GITHUB_OUTPUT ;;
            portfolio) echo "dir=SW/PORTFOLIO" >> $GITHUB_OUTPUT ;;
            blog) echo "dir=BLOG" >> $GITHUB_OUTPUT ;;
            *)
              echo "‚ùå Unknown project: $PROJECT"
              echo "Valid: helios, welcome, mcad, ecad, chladni, autocrate, portfolio, blog"
              exit 1
              ;;
          esac

      - name: Build WASM
        working-directory: ./${{ steps.build.outputs.dir }}
        run: trunk build --release

      - name: Deploy to Cloudflare Pages
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npm install -g wrangler
          npx wrangler pages project create preview-${{ steps.project.outputs.name }} --production-branch=main 2>/dev/null || true
          DEPLOY_OUTPUT=$(npx wrangler pages deploy ${{ steps.build.outputs.dir }}/dist --project-name=preview-${{ steps.project.outputs.name }} --branch=preview-${{ steps.issue.outputs.number }} --commit-dirty=true 2>&1)
          echo "$DEPLOY_OUTPUT"
          URL=$(echo "$DEPLOY_OUTPUT" | grep -oP 'https://[^\s]+\.pages\.dev' | head -1)
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Post preview URL to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROJECT=${{ steps.project.outputs.name }}
          PREVIEW_URL="https://p.${PROJECT}.too.foo"
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%s)

          BODY="üåê **Preview Deployed**

          **URL:** $PREVIEW_URL
          **Project:** ${PROJECT}
          **Commit:** \`$COMMIT_SHORT\` - $COMMIT_MSG
          **Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          ---
          *Auto-deployed from \`preview/issue-${{ steps.issue.outputs.number }}\`*
          *Actual URL: ${{ steps.deploy.outputs.url }}*"

          gh issue comment ${{ steps.issue.outputs.number }} --body "$BODY"
